<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Dump Pad</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas to capture the editor content for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for the theme */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #000000; /* Solid Black */
            color: #DCD0C0; /* Beige for text */
        }
        #editor {
            font-family: "Menlo", "Consolas", "Monaco", "Liberation Mono", "Lucida Console", monospace;
            min-height: 60vh;
            outline: none;
            caret-color: #F5EFE6; /* Lighter Beige for caret */
            white-space: pre-wrap; /* Important for list logic */
        }
        /* Placeholder styling */
        #editor:empty:before {
            content: attr(data-placeholder);
            color: #5c5c5c; /* Muted beige/gray */
            pointer-events: none;
        }
        /* Custom button styles */
        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #DCD0C0;
            color: #000000;
            border-color: #DCD0C0;
        }
        .btn-primary:hover {
            background-color: #F5EFE6;
            border-color: #F5EFE6;
        }
        .btn-secondary {
            background-color: #222222;
            color: #F5EFE6;
            border-color: #444444;
        }
        .btn-secondary:hover {
            background-color: #333333;
            border-color: #555555;
        }
        .modal-button {
             background-color: #252525;
             color: #F5EFE6;
             border: 1px solid #444;
             transition: background-color 0.2s;
        }
        .modal-button:hover {
            background-color: #3a3a3a;
        }
        /* Toolbar button styling */
        .toolbar-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .toolbar-btn:hover {
            background-color: #2a2a2a;
        }
        /* --- FIX RESTORED: Active state for toolbar buttons --- */
        .toolbar-btn.active {
            background-color: #DCD0C0;
            color: #000000;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 flex-grow flex flex-col">
        <!-- Header -->
        <header class="flex justify-between items-center pb-4 border-b border-gray-800">
            <div>
                <h1 class="text-xl font-bold text-[#F5EFE6]">Brain Dump Pad</h1>
                <p class="text-sm text-gray-500">A Minimalist Tool</p>
            </div>
            <div id="time-spent" class="text-sm font-mono text-gray-500">Time spent: 0m 0s</div>
        </header>

        <!-- Toolbar -->
        <div id="toolbar" class="flex items-center flex-wrap gap-2 p-2 bg-[#111111] rounded-md my-4">
            <button data-command="bold" class="toolbar-btn font-bold">B</button>
            <button data-command="italic" class="toolbar-btn italic">I</button>
            <button data-command="underline" class="toolbar-btn underline">U</button>
            <button data-command="strikeThrough" class="toolbar-btn line-through">S</button>
        </div>

        <!-- Main Text Area -->
        <main class="flex-grow bg-[#050505] rounded-lg">
            <div id="editor"
                 contenteditable="true"
                 class="w-full h-full p-4 rounded-lg"
                 data-placeholder="Type whatever's in your mind... it's your chaos pad.">
            </div>
        </main>

        <!-- Footer -->
        <footer class="flex justify-end items-center pt-4 mt-4 border-t border-gray-800 gap-4">
            <button id="clear-btn" class="btn btn-secondary">Clear</button>
            <button id="export-btn" class="btn btn-primary">Export</button>
        </footer>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-[#111111] border border-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-6 text-[#F5EFE6]">Export As...</h2>
            <div class="grid grid-cols-1 gap-4">
                <button data-format="txt" class="modal-button w-full py-3 rounded-lg font-semibold">Text File (.txt)</button>
                <button data-format="pdf" class="modal-button w-full py-3 rounded-lg font-semibold">PDF Document (.pdf)</button>
                <button data-format="doc" class="modal-button w-full py-3 rounded-lg font-semibold">Word Document (.doc)</button>
            </div>
            <button id="close-export-modal-btn" class="mt-8 text-gray-500 hover:text-white">Cancel</button>
        </div>
    </div>
    
    <!-- Custom Alert/Confirm Modal -->
    <div id="alert-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-[#111111] border border-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 id="ac-title" class="text-xl font-bold mb-4 text-[#F5EFE6]">Are you sure?</h2>
            <p id="ac-text" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div id="ac-buttons" class="flex justify-center gap-4">
                <button id="ac-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="ac-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element references
            const editor = document.getElementById('editor');
            const timeSpentEl = document.getElementById('time-spent');
            const clearBtn = document.getElementById('clear-btn');
            const exportBtn = document.getElementById('export-btn');
            const toolbar = document.getElementById('toolbar');
            const toolbarButtons = document.querySelectorAll('.toolbar-btn');
            
            // Modal elements
            const exportModal = document.getElementById('export-modal');
            const closeExportModalBtn = document.getElementById('close-export-modal-btn');
            const acModal = document.getElementById('alert-confirm-modal');
            const acTitle = document.getElementById('ac-title');
            const acText = document.getElementById('ac-text');
            const acCancelBtn = document.getElementById('ac-cancel-btn');
            const acOkBtn = document.getElementById('ac-ok-btn');
            
            let seconds = 0;
            let acResolve = null;

            // --- Timer ---
            setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timeSpentEl.textContent = `Time spent: ${mins}m ${secs}s`;
            }, 1000);

            // --- Custom Modal Logic ---
            const showConfirmation = (title, text) => {
                acTitle.textContent = title;
                acText.textContent = text;
                acCancelBtn.style.display = 'inline-flex';
                acOkBtn.textContent = 'Confirm';
                acModal.classList.remove('hidden');
                return new Promise(resolve => { acResolve = resolve; });
            };
            
            const showAlert = (title, text) => {
                acTitle.textContent = title;
                acText.textContent = text;
                acCancelBtn.style.display = 'none';
                acOkBtn.textContent = 'OK';
                acModal.classList.remove('hidden');
                 return new Promise(resolve => { acResolve = resolve; });
            };

            acOkBtn.addEventListener('click', () => {
                acModal.classList.add('hidden');
                if (acResolve) acResolve(true);
            });

            acCancelBtn.addEventListener('click', () => {
                acModal.classList.add('hidden');
                if (acResolve) acResolve(false);
            });

            // --- Toolbar actions ---
            toolbar.addEventListener('click', (e) => {
                const button = e.target.closest('button.toolbar-btn');
                if (button && button.dataset.command) {
                    e.preventDefault();
                    document.execCommand(button.dataset.command, false, null);
                    editor.focus();
                    updateToolbarState(); // Update state immediately after click
                }
            });

            // --- FIX RESTORED: Update toolbar button state based on selection ---
            const updateToolbarState = () => {
                toolbarButtons.forEach(button => {
                    const command = button.dataset.command;
                    if(command){
                        try {
                            const isActive = document.queryCommandState(command);
                            button.classList.toggle('active', isActive);
                        } catch (e) { /* ignore errors */ }
                    }
                });
            };

            // Add event listeners to update the toolbar
            editor.addEventListener('keyup', updateToolbarState);
            editor.addEventListener('click', updateToolbarState);
            document.addEventListener('selectionchange', updateToolbarState);


            // --- Automatic List Creation ---
            editor.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const selection = window.getSelection();
                    if (!selection.rangeCount) return;
                    
                    const range = selection.getRangeAt(0);
                    const node = range.startContainer;

                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent.substring(0, range.startOffset);
                        const currentLine = text.split('\n').pop();
                        
                        const olMatch = currentLine.match(/^(\s*)(\d+)\.\s*(.*)/);
                        if (olMatch) {
                            e.preventDefault();
                            const indent = olMatch[1] || '';
                            const number = parseInt(olMatch[2], 10);
                            const content = olMatch[3];

                            if (content.length === 0) {
                                document.execCommand('insertText', false, '\n');
                            } else {
                                const nextLine = `\n${indent}${number + 1}. `;
                                document.execCommand('insertText', false, nextLine);
                            }
                            return;
                        }

                        const ulMatch = currentLine.match(/^(\s*)([-*+])\s*(.*)/);
                        if (ulMatch) {
                            e.preventDefault();
                            const indent = ulMatch[1] || '';
                            const bullet = ulMatch[2];
                            const content = ulMatch[3];

                            if (content.length === 0) {
                                document.execCommand('insertText', false, '\n');
                            } else {
                                const nextLine = `\n${indent}${bullet} `;
                                document.execCommand('insertText', false, nextLine);
                            }
                            return;
                        }
                    }
                }
            });


            // --- Clear Button ---
            clearBtn.addEventListener('click', async () => {
                const confirmed = await showConfirmation('Clear Pad?', 'Are you sure you want to clear the entire pad? This cannot be undone.');
                if (confirmed) {
                    editor.innerHTML = '';
                }
            });

            // --- Export Modal & Logic ---
            exportBtn.addEventListener('click', () => exportModal.classList.remove('hidden'));
            closeExportModalBtn.addEventListener('click', () => exportModal.classList.add('hidden'));
            exportModal.addEventListener('click', (e) => {
                if (e.target === exportModal) exportModal.classList.add('hidden');
            });

            exportModal.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-format]');
                if (!button) return;

                const format = button.dataset.format;
                const originalText = button.textContent;
                button.textContent = 'Generating...';

                setTimeout(() => {
                    try {
                        switch (format) {
                            case 'txt': exportAsTxt(); break;
                            case 'pdf': exportAsPdf(); break;
                            case 'doc': exportAsDoc(); break;
                        }
                    } catch (error) {
                        console.error(`Export failed for ${format}:`, error);
                        showAlert('Export Error', `Sorry, could not generate the ${format.toUpperCase()} file.`);
                    } finally {
                        button.textContent = originalText;
                        exportModal.classList.add('hidden');
                    }
                }, 50);
            });
            
            function downloadFile(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportAsTxt() {
                const content = editor.innerText;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                downloadFile(url, 'braindump.txt');
                URL.revokeObjectURL(url);
            }

            function exportAsDoc() {
                const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word</title><style>body{background-color: #000; color: #DCD0C0; font-family: sans-serif; white-space: pre-wrap;}</style></head><body>`;
                const footer = "</body></html>";
                const sourceHTML = header + editor.innerHTML + footer;
                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                downloadFile(source, 'braindump.doc');
            }

            function exportAsPdf() {
                const { jsPDF } = window.jspdf;
                html2canvas(editor, {
                    backgroundColor: '#050505',
                    scale: 2
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: 'p',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save('braindump.pdf');
                }).catch(err => {
                    console.error("PDF generation failed:", err);
                    showAlert('PDF Error', "Sorry, there was a problem generating the PDF.");
                });
            }
        });
    </script>
</body>
</html>
